**- TCP头的字段：**

* 序号 (Seq)
* 确认 (ACK)
* 确认号 (ack)
* 同步 (SYN)

**- 确认号和序号：**

确认号占 4 字节，序号占 2 个字节；确认号是期望收到对方下一个报文段的第一个数据字节的序号。例如，B 正确收到了 A 发送过来的一个报文段，其序号字段值是501，而数据长度是 200 字节 (序号501 ~ 700) ， 这表明 B 正确收到了 A 发送的到序号 700 为止的数据。因此， B 期望收到 A的下一个数据序号是 701，于是 B 在发送给 A 的确认报文段中把确认号置为 701。
**- 确认号和确认：**

ACK 被设置为 1 表示确认号字段是有效的；如果 ACK 为 0，则该段不包含确认信息，即确认号字段可以忽略。

---



![image-20200723103319865](https://github.com/OnlyThePiano/Notes/blob/master/images/image-20200723103319865.png)

一开始，B 的 TCP 服务器进程先创建 `传输控制块TCB` ，准备接受客户进程的连接请
求。然后服务器进程就处于 `LISTEN` (收听)状态，等待客户的连接请求。如有，即作出响应。

(1) A 的 TCP 客户进程也是首先创建 `传输控制模块TCB` 。然后，在打算建立 TCP 连接时，
向 B 发出连接请求报文段，这时首部中的同步位 SYN = 1，同时选择一个 初始序号 seq  = x。这时，TCP 客户进程进入 `SYN-SENT`  (同步已发送) 状态。

(2) B 收到连接请求报文段后，如同意建立连接，则向 A 发送确认。在确认报文段中应把 SYN 位和 ACK 位都置 1，确认号 ack = x + 1，初始序号 seq = y。这时 TCP 服务器进程进入 `SYN-RCVD`  (同步收到) 状态。



(3) TCP 客户进程收到 B 的确认后，还要向 B 给出确认。将确认报文段的 ACK 位置 1 ，确认号 ack = y + 1，序号 seq = x + 1。这时 TCP 连接已经建立，A 进入 `ESTABLISHED`  (已建立连接) 状态。当 B 收到 A 的确认后，也进入 `ESTABLISHED` 状态。



**第 2 次握手传回了 ACK，为什么还要传回 SYN ？**

回传 SYN 是为了建立并确认从服务端到客户端的通信。而每发送一个 SYN，序列号就会自动+1。

> SYN 同步序列号(Synchronize Sequence Numbers) 是 TCP/IP 建立连接时使用的握手信号。在客户机和服务器之间建立正常的 TCP 网络连接时，客户机首先发出一个 SYN 报文段，服务器使用 SYN-ACK 报文段应答表示接收到了这个报文段，如果丢失，该 SYN 段就会重传；最后客户机再以 ACK(Acknowledgement）报文段响应。这样在客户机和服务器之间才能建立起可靠的 TCP 连接，数据才可以在客户机和服务器之间传递。

> SYN 报文段：一个在 TCP 头部的 SYN 位字段置位的 TCP/IP 数据包。客户端和服务器利用 SYN 报文段交换彼此的初始序列号。

